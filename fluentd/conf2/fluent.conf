<system>
  log_level info
  workers 1
</system>

# ============================================================
# 1. 兩個數據來源 (Sources)
# ============================================================

<source>
  @type forward
  bind 0.0.0.0
  port 24224
  @label @APP
</source>

<source>
  @type http
  bind 0.0.0.0
  port 9880
  @label @SYSTEM
</source>

# ============================================================
# 2. 三個專門處理標籤 (Labels)
# ============================================================

# --- 標籤 [1]: @APP (FastAPI 業務日誌處理) ---
<label @APP>
  <filter fastapi.app>
    @type record_transformer
    enable_ruby true
    <record>
      hostname "#{Socket.gethostname}"
      service_name "fastapi-app"
      log_content ${record["log"] || record["message"] || ""}
      is_error ${ (record["log"].to_s =~ /ERROR/ || record["message"].to_s =~ /ERROR/) ? "true" : "false" }
    </record>
  </filter>

  # 使用 copy 同時寫入兩個索引
  <match fastapi.app>
    @type copy
    
    # 儲存點 1: 全量日誌寫入 fastapi-logs
    <store>
      @type opensearch
      host opensearch
      port 9200
      scheme http
      logstash_format true
      logstash_prefix fastapi-logs
      logstash_dateformat %Y.%m.%d
      <buffer>
        @type file
        path /fluentd/buffers/app_all.buffer
        flush_interval 5s
        retry_forever true
      </buffer>
    </store>

    # 儲存點 2: 路由到錯誤日誌處理 label
    <store>
      @type relabel
      @label @APP_ERRORS
    </store>
  </match>
</label>

# --- 標籤 [3]: @APP_ERRORS (錯誤日誌專門處理) ---
<label @APP_ERRORS>
  # 過濾：只保留錯誤日誌（is_error="true"）
  <filter **>
    @type grep
    <exclude>
      key is_error
      pattern /^false$/
    </exclude>
  </filter>

  # 寫入 fastapi-error-logs 索引
  <match **>
    @type opensearch
    host opensearch
    port 9200
    scheme http
    logstash_format true
    logstash_prefix fastapi-error-logs
    logstash_dateformat %Y.%m.%d
    <buffer>
      @type file
      path /fluentd/buffers/app_errors.buffer
      flush_interval 5s
      retry_forever true
    </buffer>
  </match>
</label>

# --- 標籤 [2]: @SYSTEM (系統指標處理) ---
<label @SYSTEM>
  <filter **>
    @type record_transformer
    <record>
      hostname "#{Socket.gethostname}"
      service_name "system-monitor"
    </record>
  </filter>

  <match **>
    @type opensearch
    host opensearch
    port 9200
    scheme http
    logstash_format true
    logstash_prefix system-metrics
    logstash_dateformat %Y.%m.%d
    <buffer>
      @type memory
      flush_interval 5s
    </buffer>
  </match>
</label>
