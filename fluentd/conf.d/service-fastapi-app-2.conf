# FastAPI App 微服務配置
# 此配置處理來自 fastapi-app 的所有日誌

# --- 標籤 [1]: @APP (FastAPI 業務日誌處理) ---
<label @APP>
  <filter fastapi.app>
    @type record_transformer
    enable_ruby true
    <record>
      # 錯誤處理：使用 rescue 確保即使字段提取失敗也不會中斷處理
      hostname ${begin; "#{Socket.gethostname}"; rescue; "unknown-host"; end}
      service_name "fastapi-app"
      
      # 錯誤處理：安全提取 log_content，避免 nil 錯誤
      log_content ${begin; (record["log"] || record["message"] || "").to_s; rescue; ""; end}
      
      # 錯誤處理：安全檢測錯誤，避免正則表達式錯誤
      is_error ${begin; (record["log"].to_s =~ /ERROR/ || record["message"].to_s =~ /ERROR/) ? "true" : "false"; rescue; "false"; end}
      
      # 錯誤處理：API 端點提取，使用 rescue 處理正則匹配失敗
      api_endpoint ${begin; if record["log"]; m = record["log"].match(/-\s+(\/[^\s]+)\s+-/); m ? m[1] : ""; elsif record["api_path"]; record["api_path"].to_s; else; ""; end; rescue; record["api_path"] ? record["api_path"].to_s : ""; end}
      
      # 錯誤處理：狀態碼提取，使用 rescue 處理正則匹配失敗
      status_code ${begin; if record["log"]; m = record["log"].match(/status=(\d+)/); m ? m[1] : ""; elsif record["status_code"]; record["status_code"].to_s; else; ""; end; rescue; record["status_code"] ? record["status_code"].to_s : ""; end}
      
      # 錯誤處理：健康檢查判斷
      is_health_check ${begin; (record["log"] && record["log"].include?("/health")) || (record["api_path"] == "/health") ? "true" : "false"; rescue; "false"; end}
      
      # 錯誤處理：添加處理時間戳和錯誤標記
      processed_at ${Time.now.utc.iso8601}
      processing_error ${begin; "false"; rescue; "true"; end}
    </record>
  </filter>

  # 使用 copy 同時寫入兩個索引
  <match fastapi.app>
    @type copy
    
    # 儲存點 1: 全量日誌寫入 fastapi-logs
    <store>
      @type opensearch
      host opensearch
      port 9200
      scheme http
      logstash_format true
      logstash_prefix fastapi-logs
      logstash_dateformat %Y.%m.%d
      <buffer>
        @type file
        path /fluentd/buffers/app_all.buffer
        flush_at_shutdown true
        flush_mode interval
        flush_interval 1s
        retry_forever true
        flush_thread_count 4
        chunk_full_threshold 0.8
        total_limit_size 1024MB
        chunk_limit_size 32MB
        queued_chunks_limit_size 4
        overflow_action throw_exception
        retry_type exponential_backoff
        compress_method gzip
      </buffer>
      # 錯誤處理：如果 OpenSearch 寫入失敗，記錄到錯誤日誌
      <secondary>
        @type file
        path /fluentd/logs/opensearch_errors.log
        flush_at_shutdown true
        flush_mode interval
        flush_interval 1s
        retry_forever true
        flush_thread_count 4
        chunk_full_threshold 0.8
        total_limit_size 1024MB
        chunk_limit_size 32MB
        queued_chunks_limit_size 4
        overflow_action throw_exception
        retry_type exponential_backoff
        compress_method gzip
      </secondary>
    </store>

    # 儲存點 2: 路由到錯誤日誌處理 label
    <store>
      @type relabel
      @label @APP_ERRORS
    </store>
  </match>
</label>

# --- 標籤 [3]: @APP_ERRORS (錯誤日誌專門處理) ---
<label @APP_ERRORS>
  # 過濾：只保留錯誤日誌（is_error="true"）
  <filter **>
    @type grep
    <exclude>
      key is_error
      pattern /^false$/
    </exclude>
  </filter>

  # 添加錯誤告警字段（帶錯誤處理）
  <filter **>
    @type record_transformer
    enable_ruby true
    <record>
      alert_priority "HIGH"
      troubleshoot_hint "Check FastAPI logs for tracebacks"
      error_index_type "fastapi-error-logs"
      
      # 錯誤處理：錯誤分類，使用 rescue 處理分類邏輯錯誤
      error_category ${begin; if record["log"] && record["log"].include?("ERROR"); record["log"].include?("validation") ? "validation_error" : "general_error"; else; ""; end; rescue; "unknown_error"; end}
      
      # 錯誤處理：添加錯誤處理時間戳
      error_detected_at ${Time.now.utc.iso8601}
    </record>
  </filter>

  # 寫入 fastapi-error-logs 索引
  <match **>
    @type opensearch
    host opensearch
    port 9200
    scheme http
    logstash_format true
    logstash_prefix fastapi-error-logs
    logstash_dateformat %Y.%m.%d
    <buffer>
      @type file
      path /fluentd/buffers/app_errors.buffer
      flush_at_shutdown true
      flush_mode interval
      flush_interval 1s
      retry_forever true
      flush_thread_count 4
      chunk_full_threshold 0.8
      total_limit_size 1024MB
      chunk_limit_size 32MB
      queued_chunks_limit_size 4
      overflow_action throw_exception
      retry_type exponential_backoff
      compress_method gzip
    </buffer>
    # 錯誤處理：如果 OpenSearch 寫入失敗，記錄到錯誤日誌
    <secondary>
      @type file
      path /fluentd/logs/opensearch_error_index_errors.log
      flush_at_shutdown true
      flush_mode interval
      flush_interval 1s
      retry_forever true
      flush_thread_count 4
      chunk_full_threshold 0.8
      total_limit_size 1024MB
      chunk_limit_size 32MB
      queued_chunks_limit_size 4
      overflow_action throw_exception
      retry_type exponential_backoff
      compress_method gzip
    </secondary>
  </match>
</label>

