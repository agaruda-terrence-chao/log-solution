# FastAPI App 微服務配置
# 此配置處理來自 fastapi-app 的所有日誌

# --- 標籤 [1]: @APP (FastAPI 業務日誌處理) ---
<label @APP>
  <filter fastapi.app>
    @type record_transformer
    enable_ruby true
    <record>
      hostname "#{Socket.gethostname}"
      service_name "fastapi-app"
      log_content ${record["log"] || record["message"] || ""}
      is_error ${ (record["log"].to_s =~ /ERROR/ || record["message"].to_s =~ /ERROR/) ? "true" : "false" }
      # 提取 API 端點
      api_endpoint ${if record["log"]; record["log"].match(/-\s+(\/[^\s]+)\s+-/); $1; elsif record["api_path"]; record["api_path"]; else; ""; end}
      # 提取狀態碼
      status_code ${if record["log"]; m = record["log"].match(/status=(\d+)/); m ? m[1] : ""; elsif record["status_code"]; record["status_code"].to_s; else; ""; end}
      # 判斷是否為健康檢查
      is_health_check ${(record["log"] && record["log"].include?("/health")) || (record["api_path"] == "/health") ? "true" : "false"}
    </record>
  </filter>

  # 使用 copy 同時寫入兩個索引
  <match fastapi.app>
    @type copy
    
    # 儲存點 1: 全量日誌寫入 fastapi-logs
    <store>
      @type opensearch
      host opensearch
      port 9200
      scheme http
      logstash_format true
      logstash_prefix fastapi-logs
      logstash_dateformat %Y.%m.%d
      <buffer>
        @type file
        path /fluentd/buffers/app_all.buffer
        flush_at_shutdown true
        flush_mode interval
        flush_interval 1s
        retry_forever true
        flush_thread_count 4
        chunk_full_threshold 0.8
        total_limit_size 1024MB
        chunk_limit_size 32MB
        queued_chunks_limit_size 4
        overflow_action throw_exception
        retry_type exponential_backoff
        compress_method gzip
      </buffer>
    </store>

    # 儲存點 2: 路由到錯誤日誌處理 label
    <store>
      @type relabel
      @label @APP_ERRORS
    </store>
  </match>
</label>

# --- 標籤 [3]: @APP_ERRORS (錯誤日誌專門處理) ---
<label @APP_ERRORS>
  # 過濾：只保留錯誤日誌（is_error="true"）
  <filter **>
    @type grep
    <exclude>
      key is_error
      pattern /^false$/
    </exclude>
  </filter>

  # 添加錯誤告警字段
  <filter **>
    @type record_transformer
    <record>
      alert_priority "HIGH"
      troubleshoot_hint "Check FastAPI logs for tracebacks"
      error_index_type "fastapi-error-logs"
      # 錯誤分類
      error_category ${if record["log"] && record["log"].include?("ERROR"); record["log"].include?("validation") ? "validation_error" : "general_error"; else; ""; end}
    </record>
  </filter>

  # 寫入 fastapi-error-logs 索引
  <match **>
    @type opensearch
    host opensearch
    port 9200
    scheme http
    logstash_format true
    logstash_prefix fastapi-error-logs
    logstash_dateformat %Y.%m.%d
    <buffer>
      @type file
      path /fluentd/buffers/app_errors.buffer
      flush_at_shutdown true
      flush_mode interval
      flush_interval 1s
      retry_forever true
      flush_thread_count 4
      chunk_full_threshold 0.8
      total_limit_size 1024MB
      chunk_limit_size 32MB
      queued_chunks_limit_size 4
      overflow_action throw_exception
      retry_type exponential_backoff
      compress_method gzip
    </buffer>
  </match>
</label>

