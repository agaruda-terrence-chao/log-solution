# <source>：定義數據來源（Input 插件）
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>


# <filter>：對符合條件的事件進行轉換、過濾
# 過濾和轉換 FastAPI 日誌
<filter fastapi.app>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service_name "fastapi-app"
    log_source "fluentd"
    timestamp ${time}
  </record>
</filter>

# 解析日誌內容，識別成功/錯誤
<filter fastapi.app>
  @type record_transformer
  enable_ruby true
  ## 移除指定欄位
  # remove_keys password, secret_token
  <record>
    log_type ${if record["log"].include?("SUCCESS"); "success"; elsif record["log"].include?("ERROR"); "error"; else; "info"; end}
    log_level ${if record["log"].include?("ERROR"); "ERROR"; else; "INFO"; end}
    is_error ${record["log"].include?("ERROR")}
    error_category ${if record["log"].include?("ERROR"); if record["log"].include?("Invalid") || record["log"].include?("validation"); "validation_error"; else; "general_error"; end; else; ""; end}
  </record>
</filter>


# <match>：定義數據輸出目標（Output 插件）
# 輸出到 OpenSearch
<match fastapi.app>
  @type opensearch
  host opensearch
  port 9200
  scheme http
  index_name fastapi-logs
  type_name _doc
  logstash_format true
  logstash_dateformat %Y.%m.%d
  logstash_prefix fastapi-logs
  include_tag_key true
  tag_key @log_name
  flush_interval 5s
  <buffer>
    @type memory
    flush_interval 5s
    chunk_limit_size 2M
    queue_limit_length 8
    retry_max_interval 30
    retry_forever true
  </buffer>
</match>

# 健康檢查端點（可選）
<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>

