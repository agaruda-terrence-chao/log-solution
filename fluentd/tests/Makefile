# Fluentd ETL Tests Makefile
# æ”¯æŒåˆ†å±¤æ¸¬è©¦çµæ§‹ï¼Œä¾¿æ–¼æ“´å±•å¤šå€‹å¾®æœå‹™
# ä½¿ç”¨é¢„æ„å»ºçš„ Docker é•œåƒåŠ é€Ÿæµ‹è¯•æ‰§è¡Œ

# Docker é•œåƒåç§°å’Œæ ‡ç­¾
DOCKER_IMAGE = fluentd-test-env
DOCKER_TAG = latest
DOCKER_FULL_IMAGE = $(DOCKER_IMAGE):$(DOCKER_TAG)

# å·¥ä½œç›®å½•
TESTS_DIR := $(shell pwd)
FLUENTD_DIR := $(shell dirname $(TESTS_DIR))

# æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ Dockerï¼ˆå¦‚æœæœ¬åœ°æœ‰ Ruby ç¯å¢ƒï¼Œå¯ä»¥è®¾ç½® USE_LOCAL=trueï¼‰
USE_LOCAL ?= false

# æ£€æŸ¥æœ¬åœ° Ruby ç¯å¢ƒ
HAS_RUBY := $(shell command -v ruby 2> /dev/null)
HAS_BUNDLER := $(shell command -v bundle 2> /dev/null)

# Docker è¿è¡Œå‘½ä»¤ï¼ˆä½¿ç”¨é¢„æ„å»ºé•œåƒï¼‰
DOCKER_RUN = docker run --rm \
	-v "$(FLUENTD_DIR):/workspace/fluentd" \
	-w /workspace/fluentd/tests \
	$(DOCKER_FULL_IMAGE)


.PHONY: all
all: test

# ============================================================
# Docker é•œåƒæ„å»º
# ============================================================

.PHONY: build-image
build-image:
	@echo "ğŸ”¨ æ§‹å»ºæ¸¬è©¦ç’°å¢ƒ Docker é¡åƒ..."
	@cd $(TESTS_DIR) && docker build -t $(DOCKER_FULL_IMAGE) -f Dockerfile .
	@echo "âœ… é¡åƒæ§‹å»ºå®Œæˆ: $(DOCKER_FULL_IMAGE)"

.PHONY: image-exists
image-exists:
	@docker image inspect $(DOCKER_FULL_IMAGE) > /dev/null 2>&1 || \
		($(MAKE) build-image)

# ============================================================
# æœ¬åœ°ç¯å¢ƒæ£€æŸ¥
# ============================================================

.PHONY: check-local
check-local:
	@if [ "$(USE_LOCAL)" = "true" ]; then \
		if [ -z "$(HAS_RUBY)" ]; then \
			echo "âŒ éŒ¯èª¤: æœªæ‰¾åˆ° Rubyã€‚è«‹å®‰è£ Ruby æˆ–ä½¿ç”¨ Docker (USE_LOCAL=false)"; \
			exit 1; \
		fi; \
		if [ -z "$(HAS_BUNDLER)" ]; then \
			echo "âŒ éŒ¯èª¤: æœªæ‰¾åˆ° bundlerã€‚è«‹é‹è¡Œ 'gem install bundler' æˆ–ä½¿ç”¨ Docker (USE_LOCAL=false)"; \
			exit 1; \
		fi; \
		if [ ! -f Gemfile.lock ] || [ Gemfile -nt Gemfile.lock ]; then \
			echo "ğŸ“¦ å®‰è£ä¾è³´..." && bundle install; \
		fi; \
	fi

# ============================================================
# æµ‹è¯•ç›®æ ‡
# ============================================================

.PHONY: test
test: test-syntax test-unit test-integration
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ"

.PHONY: test-syntax
test-syntax: check-local
	@echo "ğŸ” é‹è¡Œé…ç½®èªæ³•é©—è­‰..."
	@if [ "$(USE_LOCAL)" = "true" ]; then \
		bundle exec ruby test_config_syntax.rb; \
	else \
		$(MAKE) image-exists > /dev/null 2>&1; \
		$(DOCKER_RUN) ruby test_config_syntax.rb; \
	fi

.PHONY: test-unit
test-unit: check-local
	@echo "ğŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦ï¼ˆé€šç”¨ Filter é‚è¼¯ï¼‰..."
	@find unit -name "test_*.rb" -type f | while read test_file; do \
		echo "  - $$test_file"; \
		if [ "$(USE_LOCAL)" = "true" ]; then \
			bundle exec ruby "$$test_file" || exit 1; \
		else \
			$(MAKE) image-exists > /dev/null 2>&1; \
			$(DOCKER_RUN) ruby "$$test_file" || exit 1; \
		fi; \
	done

.PHONY: test-integration
test-integration: check-local
	@echo "ğŸ”— é‹è¡Œæ•´åˆæ¸¬è©¦ï¼ˆå¾®æœå‹™ ETLï¼‰..."
	@find integration/services -name "test_*_etl.rb" -type f | while read test_file; do \
		echo "  - $$test_file"; \
		if [ "$(USE_LOCAL)" = "true" ]; then \
			bundle exec ruby "$$test_file" || exit 1; \
		else \
			$(MAKE) image-exists > /dev/null 2>&1; \
			$(DOCKER_RUN) ruby "$$test_file" || exit 1; \
		fi; \
	done

.PHONY: test-fastapi
test-fastapi: check-local
	@echo "ğŸš€ é‹è¡Œ FastAPI App ETL æ¸¬è©¦..."
	@if [ "$(USE_LOCAL)" = "true" ]; then \
		bundle exec ruby integration/services/fastapi_app/test_fastapi_app_etl.rb; \
	else \
		$(MAKE) image-exists > /dev/null 2>&1; \
		$(DOCKER_RUN) ruby integration/services/fastapi_app/test_fastapi_app_etl.rb; \
	fi

.PHONY: test-order-app
test-order-app: check-local
	@echo "ğŸ“¦ é‹è¡Œ Order App ETL æ¸¬è©¦..."
	@if [ "$(USE_LOCAL)" = "true" ]; then \
		bundle exec ruby integration/services/order_app/test_order_app_etl.rb; \
	else \
		$(MAKE) image-exists > /dev/null 2>&1; \
		$(DOCKER_RUN) ruby integration/services/order_app/test_order_app_etl.rb; \
	fi

.PHONY: test-user-app
test-user-app: check-local
	@echo "ğŸ‘¤ é‹è¡Œ User App ETL æ¸¬è©¦..."
	@if [ "$(USE_LOCAL)" = "true" ]; then \
		bundle exec ruby integration/services/user_app/test_user_app_etl.rb; \
	else \
		$(MAKE) image-exists > /dev/null 2>&1; \
		$(DOCKER_RUN) ruby integration/services/user_app/test_user_app_etl.rb; \
	fi

# ============================================================
# è¾…åŠ©å‘½ä»¤
# ============================================================

.PHONY: install-deps
install-deps:
	@echo "ğŸ“¦ å®‰è£æ¸¬è©¦ä¾è³´..."
	@if [ "$(USE_LOCAL)" = "true" ]; then \
		bundle install; \
	else \
		$(MAKE) build-image; \
	fi

.PHONY: clean
clean:
	@echo "ğŸ§¹ æ¸…ç†æ¸¬è©¦ç”¢ç‰©..."
	@rm -f *.log
	@rm -rf .bundle
	@rm -rf vendor
	@rm -f Gemfile.lock

.PHONY: clean-image
clean-image:
	@echo "ğŸ§¹ æ¸…ç† Docker é¡åƒ..."
	@docker rmi $(DOCKER_FULL_IMAGE) 2>/dev/null || true

.PHONY: clean-all
clean-all: clean clean-image

.PHONY: help
help:
	@echo "Fluentd ETL Tests Makefile"
	@echo ""
	@echo "æ¸¬è©¦å‘½ä»¤:"
	@echo "  make test              - é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make test-syntax       - é‹è¡Œé…ç½®èªæ³•é©—è­‰"
	@echo "  make test-unit         - é‹è¡Œå–®å…ƒæ¸¬è©¦"
	@echo "  make test-integration  - é‹è¡Œæ•´åˆæ¸¬è©¦"
	@echo "  make test-fastapi      - é‹è¡Œ FastAPI æ¸¬è©¦"
	@echo "  make test-order-app    - é‹è¡Œ Order App æ¸¬è©¦"
	@echo "  make test-user-app     - é‹è¡Œ User App æ¸¬è©¦"
	@echo ""
	@echo "æ§‹å»ºå‘½ä»¤:"
	@echo "  make build-image       - æ§‹å»ºæ¸¬è©¦ç’°å¢ƒ Docker é¡åƒ"
	@echo "  make install-deps      - å®‰è£æ¸¬è©¦ä¾è³´"
	@echo ""
	@echo "æ¸…ç†å‘½ä»¤:"
	@echo "  make clean             - æ¸…ç†æ¸¬è©¦ç”¢ç‰©"
	@echo "  make clean-image       - æ¸…ç† Docker é¡åƒ"
	@echo "  make clean-all         - æ¸…ç†æ‰€æœ‰ï¼ˆç”¢ç‰© + é¡åƒï¼‰"
	@echo ""
	@echo "ç’°å¢ƒé¸é …:"
	@echo "  USE_LOCAL=true         - ä½¿ç”¨æœ¬åœ° Ruby ç’°å¢ƒï¼ˆéœ€è¦å®‰è£ Ruby å’Œ bundlerï¼‰"
	@echo "  USE_LOCAL=false        - ä½¿ç”¨ Dockerï¼ˆé»˜èªï¼‰"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make test                      # ä½¿ç”¨ Docker é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  USE_LOCAL=true make test       # ä½¿ç”¨æœ¬åœ°ç’°å¢ƒé‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make build-image && make test  # æ§‹å»ºé¡åƒå¾Œé‹è¡Œæ¸¬è©¦"
