# Helm Charts Makefile
# ç”¨äºéƒ¨ç½²å’Œç®¡ç†ç»Ÿä¸€çš„ Fluent æ—¥å¿—æ”¶é›†é“¾è·¯

NAMESPACE ?= fluent
RELEASE_NAME ?= fluent

# OpenSearch é…ç½®ï¼ˆæ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´ï¼‰
OPENSEARCH_SERVICE ?= opensearch-cluster-master
OPENSEARCH_NAMESPACE ?= opensearch

.PHONY: help
help:
	@echo "ç»Ÿä¸€çš„ Fluent æ—¥å¿—æ”¶é›†é“¾è·¯ Helm Chart"
	@echo ""
	@echo "éƒ¨ç½²å‘½ä»¤:"
	@echo "  make install               - éƒ¨ç½² Fluent æ ˆï¼ˆfluent-bit + fluentdï¼‰"
	@echo ""
	@echo "å‡çº§å‘½ä»¤:"
	@echo "  make upgrade               - å‡çº§ Fluent æ ˆ"
	@echo ""
	@echo "å¸è½½å‘½ä»¤:"
	@echo "  make uninstall             - å¸è½½ Fluent æ ˆ"
	@echo ""
	@echo "éªŒè¯å‘½ä»¤:"
	@echo "  make status                - æŸ¥çœ‹æ‰€æœ‰ç»„ä»¶çŠ¶æ€"
	@echo "  make test-connection      - æµ‹è¯•ç»„ä»¶è¿æ¥"
	@echo "  make lint                  - æ£€æŸ¥ Helm Chart è¯­æ³•"
	@echo "  make template              - ç”Ÿæˆ Kubernetes æ¸…å•"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡:"
	@echo "  NAMESPACE                  - Kubernetes å‘½åç©ºé—´ï¼ˆé»˜è®¤: fluentï¼‰"
	@echo "  RELEASE_NAME               - Helm Release åç§°ï¼ˆé»˜è®¤: fluentï¼‰"
	@echo "  OPENSEARCH_SERVICE         - OpenSearch æœåŠ¡åç§°ï¼ˆé»˜è®¤: opensearch-cluster-masterï¼‰"
	@echo "  OPENSEARCH_NAMESPACE       - OpenSearch å‘½åç©ºé—´ï¼ˆé»˜è®¤: opensearchï¼‰"

.PHONY: namespace
namespace:
	@echo "åˆ›å»ºå‘½åç©ºé—´: $(NAMESPACE)"
	@kubectl create namespace $(NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -

# ============================================================
# éƒ¨ç½²å‘½ä»¤
# ============================================================

.PHONY: install
install: namespace
	@echo "ğŸš€ éƒ¨ç½²ç»Ÿä¸€çš„ Fluent æ ˆï¼ˆfluent-bit + fluentdï¼‰..."
	@helm install $(RELEASE_NAME) . \
		--namespace $(NAMESPACE) \
		--set fluentd.opensearch.service.name=$(OPENSEARCH_SERVICE) \
		--set fluentd.opensearch.service.namespace=$(OPENSEARCH_NAMESPACE) \
		--set fluentd.opensearch.useService=true \
		--set fluentd.opensearch.scheme=http \
		--set fluentd.opensearch.verifySsl=false
	@echo "â³ ç­‰å¾… Fluent Bit å°±ç»ª..."
	@kubectl wait --for=condition=ready pod \
		-l app.kubernetes.io/component=fluent-bit \
		-n $(NAMESPACE) \
		--timeout=300s || true
	@echo "â³ ç­‰å¾… Fluentd å°±ç»ª..."
	@kubectl wait --for=condition=ready pod \
		-l app.kubernetes.io/component=fluentd \
		-n $(NAMESPACE) \
		--timeout=300s || true
	@echo "âœ… Fluent æ ˆéƒ¨ç½²å®Œæˆ"

# ============================================================
# å‡çº§å‘½ä»¤
# ============================================================

.PHONY: upgrade
upgrade:
	@echo "ğŸ”„ å‡çº§ Fluent æ ˆ..."
	@helm upgrade $(RELEASE_NAME) . \
		--namespace $(NAMESPACE) \
		--set fluentd.opensearch.service.name=$(OPENSEARCH_SERVICE) \
		--set fluentd.opensearch.service.namespace=$(OPENSEARCH_NAMESPACE) \
		--set fluentd.opensearch.useService=true \
		--set fluentd.opensearch.scheme=http \
		--set fluentd.opensearch.verifySsl=false
	@echo "âœ… Fluent æ ˆå‡çº§å®Œæˆ"

# ============================================================
# å¸è½½å‘½ä»¤
# ============================================================

.PHONY: uninstall
uninstall:
	@echo "ğŸ—‘ï¸  å¸è½½ Fluent æ ˆ..."
	@helm uninstall $(RELEASE_NAME) --namespace $(NAMESPACE) || true
	@echo "âœ… Fluent æ ˆå¸è½½å®Œæˆ"

# ============================================================
# éªŒè¯å‘½ä»¤
# ============================================================

.PHONY: status
status:
	@echo "ğŸ“Š Fluent æ ˆçŠ¶æ€:"
	@echo ""
	@echo "=== Fluent Bit ==="
	@kubectl get pods,svc -n $(NAMESPACE) -l app.kubernetes.io/component=fluent-bit || true
	@echo ""
	@echo "=== Fluentd ==="
	@kubectl get pods,svc -n $(NAMESPACE) -l app.kubernetes.io/component=fluentd || true

.PHONY: test-connection
test-connection:
	@echo "ğŸ” æµ‹è¯•ç»„ä»¶è¿æ¥..."
	@echo ""
	@echo "1. æµ‹è¯• Fluent Bit -> Fluentd è¿æ¥:"
	@kubectl run -it --rm test-connection-$$(date +%s) \
		--image=curlimages/curl:latest \
		--restart=Never \
		-n $(NAMESPACE) -- \
		curl -X POST http://$(RELEASE_NAME)-fluent-bit.$(NAMESPACE).svc.cluster.local:8888 \
		-H "Content-Type: application/json" \
		-d '{"message":"[ORDER] Connection test","level":"INFO","order_id":"TEST-001"}' || true
	@echo ""
	@echo "2. æ£€æŸ¥ Fluentd æ—¥å¿—:"
	@kubectl logs -n $(NAMESPACE) -l app.kubernetes.io/component=fluentd --tail=10 || true

.PHONY: lint
lint:
	@echo "ğŸ” æ£€æŸ¥ Helm Chart è¯­æ³•..."
	@helm lint . || echo "âš ï¸  fluent lint å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦å®‰è£… helmï¼‰"

.PHONY: template
template:
	@echo "ğŸ“„ ç”Ÿæˆ Kubernetes æ¸…å•:"
	@helm template $(RELEASE_NAME) . \
		--set fluentd.opensearch.service.name=$(OPENSEARCH_SERVICE) \
		--set fluentd.opensearch.service.namespace=$(OPENSEARCH_NAMESPACE) \
		--set fluentd.opensearch.useService=true \
		--set fluentd.opensearch.scheme=http \
		--set fluentd.opensearch.verifySsl=false || echo "éœ€è¦å®‰è£… helm"
