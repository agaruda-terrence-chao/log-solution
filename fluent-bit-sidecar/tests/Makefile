# Fluent Bit Tests Makefile
# æ”¯æŒé…ç½®æ–‡ä»¶æµ‹è¯•å’Œé›†æˆæµ‹è¯•

# å·¥ä½œç›®å½•
TESTS_DIR := $(shell pwd)
FLUENT_BIT_DIR := $(shell dirname $(TESTS_DIR))

# Fluent Bit å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼‰
FLUENT_BIT_BIN ?= fluent-bit

# æ£€æŸ¥ Fluent Bit æ˜¯å¦å¯ç”¨
HAS_FLUENT_BIT := $(shell command -v $(FLUENT_BIT_BIN) 2> /dev/null || docker exec log-solution-fluentd-3-fluent-bit-sidecar test -f /fluent-bit/bin/fluent-bit 2> /dev/null)

.PHONY: all
all: test

# ============================================================
# æµ‹è¯•ç›®æ ‡
# ============================================================

.PHONY: test
test: test-config test-integration
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆ"

.PHONY: test-config
test-config:
	@echo "ğŸ” é‹è¡Œ Fluent Bit é…ç½®æ–‡ä»¶æ¸¬è©¦..."
	@if [ -z "$(HAS_FLUENT_BIT)" ]; then \
		echo "âš ï¸  è­¦å‘Š: fluent-bit å‘½ä»¤ä¸å¯ç”¨ï¼Œéƒ¨åˆ†æ¸¬è©¦å°‡è¢«è·³é"; \
		echo "   å¯ä»¥é€šéç’°å¢ƒè®Šé‡ FLUENT_BIT_BIN æŒ‡å®šè·¯å¾‘ï¼Œæˆ–ä½¿ç”¨ Docker ç’°å¢ƒ"; \
	fi
	@cd $(TESTS_DIR) && ruby test_fluent_bit_config.rb

.PHONY: test-integration
test-integration:
	@echo "ğŸ”— é‹è¡Œ Fluent Bit é›†æˆæ¸¬è©¦..."
	@echo "âš ï¸  æ³¨æ„: é›†æˆæ¸¬è©¦éœ€è¦ Fluent Bit æœå‹™é‹è¡Œåœ¨ localhost:8888 å’Œ localhost:8889"
	@cd $(TESTS_DIR) && ruby test_fluent_bit_integration.rb

# ============================================================
# è¾…åŠ©å‘½ä»¤
# ============================================================

.PHONY: check-service
check-service:
	@echo "ğŸ” æª¢æŸ¥ Fluent Bit æœå‹™ç‹€æ…‹..."
	@if docker ps | grep -q fluent-bit-sidecar; then \
		echo "âœ… Fluent Bit æœå‹™æ­£åœ¨é‹è¡Œ"; \
		docker ps --filter "name=fluent-bit-sidecar" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"; \
	else \
		echo "âŒ Fluent Bit æœå‹™æœªé‹è¡Œ"; \
		echo "   è«‹é‹è¡Œ: cd ../.. && docker-compose -f docker-compose-fluentd-3.yaml up -d fluent-bit-sidecar"; \
	fi

.PHONY: start-service
start-service:
	@echo "ğŸš€ å•Ÿå‹• Fluent Bit æœå‹™..."
	@cd $(FLUENT_BIT_DIR)/../.. && docker-compose -f docker-compose-fluentd-3.yaml up -d fluent-bit-sidecar
	@echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
	@sleep 3
	@$(MAKE) check-service

.PHONY: help
help:
	@echo "Fluent Bit Tests Makefile"
	@echo ""
	@echo "æ¸¬è©¦å‘½ä»¤:"
	@echo "  make test              - é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make test-config       - é‹è¡Œé…ç½®æ–‡ä»¶æ¸¬è©¦"
	@echo "  make test-integration  - é‹è¡Œé›†æˆæ¸¬è©¦"
	@echo ""
	@echo "æœå‹™ç®¡ç†:"
	@echo "  make check-service     - æª¢æŸ¥ Fluent Bit æœå‹™ç‹€æ…‹"
	@echo "  make start-service     - å•Ÿå‹• Fluent Bit æœå‹™"
	@echo ""
	@echo "ç’°å¢ƒè®Šé‡:"
	@echo "  FLUENT_BIT_BIN        - Fluent Bit å¯åŸ·è¡Œæ–‡ä»¶è·¯å¾‘ï¼ˆé»˜èª: fluent-bitï¼‰"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make test                      # é‹è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make start-service && make test-integration  # å•Ÿå‹•æœå‹™å¾Œé‹è¡Œé›†æˆæ¸¬è©¦"
	@echo "  FLUENT_BIT_BIN=/path/to/fluent-bit make test-config  # æŒ‡å®š Fluent Bit è·¯å¾‘"
